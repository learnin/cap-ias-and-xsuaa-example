_schema-version: 3.3.0
ID: cap01
version: 1.0.0-SNAPSHOT
description: "A simple CAP project."
parameters:
  enable-parallel-deployments: true
  deploy_mode: html5-repo
modules:
  - name: cap01-srv
    type: java
    path: srv
    parameters:
      instances: 1
      buildpack: sap_java_buildpack_jakarta
      routes:
        - route: "${default-url}"
        - route: "${default-host}.cert.${default-domain}"
    properties:
      SPRING_PROFILES_ACTIVE: cloud,sandbox
      JBP_CONFIG_COMPONENTS: "jres: ['com.sap.xs.java.buildpack.jre.SAPMachineJRE']"
      JBP_CONFIG_SAP_MACHINE_JRE: '{ version: 21.+ }'
      AMS_DCL_ROOT: ams/dcl
      # JBP_CONFIG_JAVA_OPTS:
      #   from_environment: false
      #   java_opts: >
      #     -javaagent:META-INF/.sap_java_buildpack/otel_agent/opentelemetry-javaagent.jar
      #     -Dotel.javaagent.extensions=META-INF/.sap_java_buildpack/otel_agent_extension/otel-agent-ext-java.jar
      # OTEL_METRICS_EXPORTER: cloud-logging
      # OTEL_TRACES_EXPORTER: cloud-logging
      # OTEL_LOGS_EXPORTER: none
    build-parameters:
      builder: custom
      commands:
        - mvn clean package -DskipTests=true --batch-mode
      build-result: target/*-exec.jar
    provides:
      - name: srv-api # required by consumers of CAP services (e.g. approuter)
        properties:
          srv-url: ${default-url}
          srv-cert-url: '${protocol}://${default-host}.cert.${default-domain}'
    requires:
      - name: cap01-auth
      - name: cap01-db
      - name: cap01-destination
      - name: cap01-ias-auth
        parameters:
          config:
            credential-type: X509_GENERATED
            app-identifier: srv
      - name: cloud-logging-instance
    deployed-after:
      - cap01-ams-policies-deployer

  - name: cap01-db-deployer
    type: hdb
    path: db
    parameters:
      buildpack: nodejs_buildpack
    build-parameters:
      builder: custom
      commands:
        - npm run build
    requires:
      - name: cap01-db

  - name: cap01
    type: approuter.nodejs
    path: app/router
    parameters:
      keep-existing-routes: true
      disk-quota: 256M
      memory: 256M
    requires:
      - name: srv-api
        group: destinations
        properties:
          name: srv-api # must be used in xs-app.json as well
          url: ~{srv-cert-url}
          forwardAuthToken: true
          forwardAuthCertificates: true
          strictSSL: true
      - name: cap01-destination
      - name: cap01-ias-auth
        parameters:
          config:
            credential-type: X509_GENERATED
            app-identifier: approuter
      # - name: cap01-html5-runtime
    provides:
      - name: app-api
        properties:
          app-protocol: ${protocol}
          app-uri: ${default-uri}
          url: ${default-url}

  - name: cap01-ams-policies-deployer
    type: javascript.nodejs
    path: .
    build-parameters:
      builder: custom
      commands:
        - npx cds build --for ams
      build-result: srv/src/gen/policies
    parameters:
      buildpack: nodejs_buildpack
      no-route: true
      no-start: true
      tasks:
        - name: deploy-dcl
          command: npm start
          memory: 512M
    requires:
      - name: cap01-ias-auth
        parameters:
          config:
            credential-type: X509_GENERATED
            app-identifier: ams-policy-deployer

  # - name: cap01-app-deployer
  #   type: com.sap.application.content
  #   path: .
  #   requires:
  #     - name: cap01-html5-repo-host
  #       parameters:
  #         content-target: true
  #   build-parameters:
  #     build-result: resources
  #     requires:

resources:
  - name: cap01-auth
    type: org.cloudfoundry.managed-service
    parameters:
      service: xsuaa
      service-plan: application
      path: ./xs-security.json
      config:
        xsappname: cap01-${org}-${space}
        tenant-mode: dedicated
        oauth2-configuration:
          redirect-uris:
            - https://~{app-api/app-uri}/**
    requires:
      - name: app-api
  - name: cap01-ias-auth
    type: org.cloudfoundry.managed-service
    parameters:
      service: identity
      service-name: cap01-ias-auth
      service-plan: application
      config:
        display-name: cap01-ias
        # authorization:
        #   enabled: true
        # oauth2-configuration:
        #   redirect-uris:
        #     - https://3d297575trial-trial2-inqczjed-dev-cap01.cfapps.ap21.hana.ondemand.com/login/callback?authType=ias
        #   # post-logout-redirect-uris:
        #     # - https://*.<landscapeDomain>/*/logout.html
        xsuaa-cross-consumption: true
        # consumed-services:
        #   - service-instance-name: cap01-destination
        #   - service-instance-name: cap01-auth
        # Configuration details, like service bindings (optional)
        # consumed-services:  # If your app uses other services
        #   - service-instance-name: <another-service-instance-name>
        #     xsuaa-cross-consumption: true # If token exchange is needed
        provided-apis:
          - name: catalog-api
            description: api exposed by catalog service app
        oauth2-configuration:
          redirect-uris:
            - ~{app-api/app-protocol}://~{app-api/app-uri}/login/callback
          post-logout-redirect-uris:
            - ~{app-api/app-protocol}://~{app-api/app-uri}/*/logout.html
        authorization:
          enabled: true
    requires:
      - name: app-api
    # - name: cap01-ias
    #   type: org.cloudfoundry.existing-service
    #   parameters:
    #     service-name: cap01-ias
  - name: cap01-db
    type: com.sap.xs.hdi-container
    parameters:
      service: hana
      service-plan: hdi-shared
  - name: cap01-destination
    type: org.cloudfoundry.managed-service
    parameters:
      service: destination
      service-plan: lite
      config:
        HTML5Runtime_enabled: true
        init_data:
          instance:
            existing_destinations_policy: update
            destinations:
              - Name: srv-api
                URL: ~{srv-api/srv-url}
                Authentication: NoAuthentication
                Type: HTTP
                ProxyType: Internet
                HTML5.ForwardAuthToken: true
                HTML5.DynamicDestination: true
                HTML5.IASDependencyName: catalog-api
              - Name: ui5
                URL: https://ui5.sap.com
                Authentication: NoAuthentication
                Type: HTTP
                ProxyType: Internet
    requires:
      - name: srv-api
        group: destinations
        properties:
          name: srv-api # must be used in xs-app.json as well
          url: ~{srv-url}
          forwardAuthToken: true

  # - name: cap01-html5-repo-host
  #   type: org.cloudfoundry.managed-service
  #   parameters:
  #     service: html5-apps-repo
  #     service-plan: app-host
  # - name: cap01-html5-runtime
  #   type: org.cloudfoundry.managed-service
  #   parameters:
  #     service: html5-apps-repo
  #     service-plan: app-runtime

  - name: cloud-logging-instance
    type: org.cloudfoundry.managed-service
    parameters:
      service: application-logs #cloud-logging
      service-plan: lite #standard
      # config:
      #   ingest_otlp:
      #     enabled: true
